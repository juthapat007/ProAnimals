import express from 'express';
import path from 'path';
import { fileURLToPath } from 'url';
import { getPoolPromise } from './config/db.js';
import bcrypt from 'bcrypt';
import session from 'express-session';
import moment from 'moment-timezone';
import dayjs from "dayjs";
import { requireLogin } from './middleware/auth.js';
import { createRequire } from 'module';
const require = createRequire(import.meta.url);

// ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö __dirname ‡πÉ‡∏ô ES Module
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);



const app = express();
app.use(express.static(path.join(process.cwd(), "public")));

// Middleware ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö JSON ‡πÅ‡∏•‡∏∞ form
app.use(express.json()); // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö parse JSON
app.use(express.urlencoded({ extended: true })); // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö parse form data


// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ session - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤ timeout
app.use(session({
  secret: 'Why_do_we_have_to_endure',
  resave: false,
  saveUninitialized: false, // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô false ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
  cookie: {
    maxAge: 60 * 60 * 1000, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (‡πÅ‡∏ó‡∏ô 10 ‡∏ô‡∏≤‡∏ó‡∏µ)
    httpOnly: true,
    sameSite: 'lax'
  }
}));

// Static files
app.use(express.static(path.join(__dirname, 'public')));

// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ timezone
moment.tz.setDefault('Asia/Bangkok');
process.env.TZ = 'Asia/Bangkok';

// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ view engine ‚Üí EJS
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));

// Import routes ES Module ‡πÅ‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
import adminRoutes from './route/admin/index.js';
import vetRoutes from './route/vet/index.js';
import userRoutes from './route/users/index.js';
import manageQueueRouter from './route/admin/manageQueue.js';
import petsRouter from './route/users/pets.js';
import bookingRoter from './route/users/booking.js';
import insertRoter from './route/users/insert_pet.js';
import registerRoter from './route/users/register.js';
import selectTimeRoter from './route/users/select_time.js';

import confirmRouter from './route/users/confirm.js';
import successRouter from './route/users/success.js';
app.use('/users/success', successRouter);
app.use('/users/confirm', confirmRouter);

import forgotPasswordRouter from './route/users/forgot-password.js';
app.use('/users/forgot-password', forgotPasswordRouter);
import resetPasswordRouter from './route/users/reset-password.js';
app.use('/users/reset-password', resetPasswordRouter);

import selectPetRouter from "./route/users/select_pet.js";
app.use("/users/select_pet", selectPetRouter);

import editPersonRouter from "./route/users/edit_person.js";
app.use("/users/edit_person", editPersonRouter);

import editPetRouter from "./route/users/edit_pet.js";
app.use("/users/edit_pet", editPetRouter);

import historyRouter from './route/users/history.js';
app.use('/users/history', historyRouter);
import queueRoutes from "./route/users/queue.js";
app.use("/users/queue", queueRoutes);


// Import routers
import petTypeRouter from "./route/admin/pet-type.js";
app.use("/admin/manage_pet_type", petTypeRouter);

import servicePetRouter from "./route/admin/service-pet.js";
app.use("/admin/manage_service_pet", servicePetRouter);
import treatmentHistoryRouter from "./route/admin/treatmentHistory.js";
app.use("/admin/treatment_history", treatmentHistoryRouter);

import medicationHistoryRouter from "./route/admin/medicationHistory.js";
app.use("/admin/medication_history", medicationHistoryRouter);

import confirmAMRouter from "./route/admin/confirmAM.js";
app.use("/admin/confirm_AM", confirmAMRouter);


import vet_treatmentHistoryRouter from "./route/vet/treatmentHistory.js";
import vet_medicationHistoryRouter from "./route/vet/medicationHistory.js";
app.use("/veterinarian/history_treatment", vet_treatmentHistoryRouter);
app.use("/veterinarian/history_medication", vet_medicationHistoryRouter);




import totalPayRouter from './route/admin/totalPayments.js'; 
import contactCusRouter from './route/admin/customerContact.js'; 
import addPetRouter from './route/admin/add_pet.js'; 

import petServiceRoutes from "./route/admin/petService.js";

// ‚úÖ ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á admin
app.use("/admin/pet_service", petServiceRoutes);




import petOrderRoutes from './route/vet/pet_order.js';
import orderMedicationRoutes from "./route/vet/medication_order.js";
import manageHistoryRoutes from "./route/vet/manageHistory.js";
import medicationHistoryRoutes from "./route/vet/medicationHistory.js";
import manageMedicationRoutes from "./route/vet/manageMedication.js";
import reportRoutes from "./route/vet/report.js";
import workDayRoutes from "./route/vet/workDays.js";
import editHistoryRouter from "./route/vet/editHistory.js";

import managePermissionRouter from "./route/admin/managePermission.js";
app.use("/admin/mg_permission", managePermissionRouter);


// ...



// Mount routes - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£ mount route
app.use('/admin', adminRoutes);
app.use('/vet', vetRoutes);
app.use('/users', userRoutes);
app.use('/admin/mg_queue', manageQueueRouter);
app.use('/users', petsRouter);
app.use('/users', bookingRoter);
app.use('/users', insertRoter);
app.use('/users', registerRoter);
app.use('/users', selectTimeRoter);


// ‡πÄ‡∏û‡∏¥‡πà‡∏° route ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö pet service
app.use('/admin/total_pay', totalPayRouter);
app.use('/admin/contact_customer', contactCusRouter);
app.use('/admin/add_pet', addPetRouter);


app.use('/veterinarian/pet_order', petOrderRoutes);
app.use("/veterinarian/mg_history", manageHistoryRoutes);
app.use("/veterinarian/order_medication",orderMedicationRoutes);
app.use("/veterinarian/medication_history", medicationHistoryRoutes);
app.use("/veterinarian/manage_medication", manageMedicationRoutes);
app.use("/veterinarian/report", reportRoutes);
app.use("/veterinarian/work_days", workDayRoutes);
app.use("/veterinarian/edit_history", editHistoryRouter);




app.get("/users/verify-email", async (req, res) => {
  const { token } = req.query;
  const pool = getPoolPromise(); // ‡πÉ‡∏ä‡πâ pool ‡∏õ‡∏Å‡∏ï‡∏¥

  try {
    const [rows] = await pool.query(
      "SELECT email FROM email_verification WHERE token = ?",
      [token]
    );

    if (rows.length === 0) {
      return res.render('users/verify', {
        success: false,
        message: "‚ùå ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß"
      });
    }

    const email = rows[0].email;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á customer
    await pool.query(
      "UPDATE customer SET email_verified = 1 WHERE cus_email = ?",
      [email]
    );

    // ‡∏•‡∏ö token ‡∏ó‡∏¥‡πâ‡∏á
    await pool.query(
      "DELETE FROM email_verification WHERE token = ?",
      [token]
    );

    res.render('users/verify_success', {
  success: true,
  message: '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ'
});
  } catch (err) {
    console.error("Verify error:", err);
    res.render('users/verify_success', {
  success: false,
  message: '‚ùå ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß'
});
  }
});


// ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// ===== LOGIN ROUTE ===== 
app.post('/login', async (req, res) => {
  try {
    const email = req.body?.access_email || '';
    const password = req.body?.access_pwd || '';
    
    console.log("=== [LOGIN REQUEST] ===");
    console.log("Email:", email);
    console.log("Password length:", password.length);

    if (!email || !password) {
      console.log("‚ùå Missing email or password");
      return res.status(400).json({ 
        success: false, 
        message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å email ‡πÅ‡∏•‡∏∞ password' 
      });
    }

    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const pool = getPoolPromise(email);
    // console.log("‚úÖ Pool selected for:", email);

    // 1Ô∏è‚É£ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö permission
    console.log("üîç Checking permission table...");
    const [permissionResults] = await pool.query(
      'SELECT * FROM permission WHERE access_email = ?', 
      [email]
    );
    
    // console.log("üìä Permission results:", permissionResults);
    
    if (!permissionResults || permissionResults.length === 0) {
      console.log("‚ùå No user found in permission table");
      return res.status(401).json({ 
        success: false, 
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ä‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' 
      });
    }

    const user = permissionResults[0];
    console.log("üë§ User found:", {
      email: user.access_email,
      type: user.access_type,
      hasPassword: !!user.access_pwd
    });

    let hash = user.access_pwd;
    
    // ‡πÅ‡∏õ‡∏•‡∏á $2y$ ‡πÄ‡∏õ‡πá‡∏ô $2b$ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö bcrypt.js
    if (hash && hash.startsWith('$2y$')) {
      hash = hash.replace('$2y$', '$2b$');
      console.log("üîÑ Converted $2y$ to $2b$");
    }

    // 2Ô∏è‚É£ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
    console.log("üîç Comparing password...");
    const isMatch = await bcrypt.compare(password, hash);
    
    console.log("üéØ Password match result:", isMatch);
    
    if (!isMatch) {
      console.log("‚ùå Password mismatch");
      return res.status(401).json({ 
        success: false, 
        message: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' 
      });
    }

    // 3Ô∏è‚É£ ‡∏™‡∏£‡πâ‡∏≤‡∏á session
    req.session.user_email = user.access_email;
    req.session.access_type = user.access_type;

    console.log(`‚úÖ Login successful for ${email}, type: ${user.access_type}`);

    // 4Ô∏è‚É£ ‡πÅ‡∏¢‡∏Å flow ‡∏ï‡∏≤‡∏° access_type
    let redirectUrl = '/';
    
    if (user.access_type === 'customer') {
      console.log("üë• Processing customer flow...");
      // ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• customer
const [custResults] = await pool.query(
  'SELECT cus_name, cus_id, email_verified FROM customer WHERE cus_email = ?',
  [email]
);

if (!custResults || custResults.length === 0) {
  return res.status(404).json({ success: false, message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö' });
}

const customer = custResults[0];

// ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ email_verified
if (customer.email_verified !== 1) {
  return res.status(403).json({
    success: false,
    message: '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'
    
  });
}

// ‡∏ñ‡πâ‡∏≤ verified = 1 ‡∏à‡∏∂‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á session
req.session.user_name = customer.cus_name;
req.session.cus_id = customer.cus_id;
redirectUrl = '/users/main';

    } else if (user.access_type === 'admin') {
      // console.log("üë®‚Äçüíº Processing admin flow...");
      
      try {
        const [adminResults] = await pool.query(
          'SELECT admin_id, admin_name FROM admin WHERE admin_email = ?', 
          [email]
        );
        
        if (adminResults && adminResults.length > 0) {
          console.log("üìä Admin results:", adminResults);
          req.session.user_name = adminResults[0].admin_name;
          req.session.admin_id = adminResults[0].admin_id;
        } else {
          console.log("‚ö†Ô∏è No admin data found, using email as name");
          req.session.user_name = email.split('@')[0];
          req.session.admin_id = null;
        }
      } catch (adminErr) {
        console.error('‚ö†Ô∏è Admin query error (using fallback):', adminErr);
        req.session.user_name = email.split('@')[0];
        req.session.admin_id = null;
      }
      
      redirectUrl = '/admin/mg_queue';
      
    }  else if (user.access_type === 'veterinarian') {
  console.log("üë®‚Äç‚öïÔ∏è Processing veterinarian flow...");
  
  const [vetResults] = await pool.query(
    'SELECT vet_id, vet_name FROM veterinarian WHERE vet_email = ?', 
    [email]
  );
  
  console.log("üìä Veterinarian results:", vetResults);
  
  if (!vetResults || vetResults.length === 0) {
    console.log("‚ùå No veterinarian data found");
    return res.status(404).json({ 
      success: false, 
      message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö' 
    });
  }

  req.session.user_name = vetResults[0].vet_name;
  req.session.vet_id = vetResults[0].vet_id; // ‚≠ê ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏Å‡πá‡∏ö vet_id ‡πÉ‡∏ô session
  redirectUrl = '/veterinarian/pet_order';
    } else {
      console.log("‚ùå Unknown access_type:", user.access_type);
      return res.status(400).json({ 
        success: false, 
        message: `access_type "${user.access_type}" ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö` 
      });
    }

    console.log("‚úÖ Session created:", req.session);
    
    // ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö JSON response ‡πÅ‡∏ó‡∏ô redirect ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô AJAX
    if (req.headers.accept && req.headers.accept.includes('application/json')) {
      return res.json({ 
        success: true, 
        message: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        redirect: redirectUrl 
      });
    } else {
      return res.redirect(redirectUrl);
    }

  } catch (error) {
    console.error('‚ùå Login error:', error);
    return res.status(500).json({ 
      success: false, 
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: ' + error.message 
    });
  }
});



//====================================================
// ===== OTHER ROUTES =====
//====================================================

app.get('/users/main', requireLogin, (req, res) => {
  if (req.session.access_type !== 'customer') {
    return res.redirect('/');
  }
  
  // console.log("üè† Rendering users/main with session:", req.session);
  
  res.render('users/main', {
    cus_name: req.session.user_name,
    user_name: req.session.user_name,
    cus_id: req.session.cus_id,
    user_email: req.session.user_email,
    access_type: req.session.access_type
  });
});



app.post('/booking', requireLogin, async (req, res) => {
  try {
    if (req.session.access_type !== 'customer') {
      return res.redirect('/');
    }
    const { pet_id, cus_id } = req.body;
    console.log("üìã Booking request:", { pet_id, cus_id, session_cus_id: req.session.cus_id });
    if (!pet_id || !cus_id) {
      return res.redirect('/users/booking');
    }
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ cus_id ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö session ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (cus_id != req.session.cus_id) {
      return res.status(403).send('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á');
    }
    const pool = getPoolPromise(req.session.user_email);
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á
    const [petResults] = await pool.query(
      `SELECT p.pet_name, p.pet_gender, pt.type AS pet_type_name, p.img
       FROM pet p
       LEFT JOIN pet_type pt ON p.type_id = pt.type_id
       WHERE p.pet_id = ? AND p.cus_id = ?`,
      [pet_id, cus_id]
    );
    if (petResults.length === 0) {
      return res.send('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á');
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
    const [serviceResults] = await pool.query(`SELECT * FROM service_type ORDER BY service_name ASC`);

    res.render('users/booking', {
      pet_id,
      cus_id,
      pet: petResults[0],
      services: serviceResults,
      today: new Date().toISOString().slice(0, 10),
      cus_name: req.session.user_name
    });

  } catch (error) {
    console.error('‚ùå Booking page error:', error);
    res.status(500).send('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏á');
  }
});

// ‡∏´‡∏ô‡πâ‡∏≤ HTML
// app.get('/admin/manage_service_pet', (req, res) => {
//   // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå admin
//   if (!req.session.user_email) return res.redirect('/login');

//   res.render('admin/manage_service_pet', {
//     user: req.session.user_email
//   });
// });


// =====================================================================================================================
//                   
//                                     veterinarian
// 
// =====================================================================================================================



// Logout route
app.get('/logout', (req, res) => {
  req.session.destroy((err) => {
    if (err) {
      console.error('‚ùå Error destroying session:', err);
      return res.status(500).send('Logout failed');
    }

    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå cookie ‡∏î‡πâ‡∏ß‡∏¢
    res.clearCookie('connect.sid');

    // ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ public/index.html
    res.redirect('/index.html');
  });
});


// ===== API ROUTES =====
app.get('/api/available-slots', requireLogin, async (req, res) => {
  try {
    const { date, service_id } = req.query;
    const pool = getPoolPromise(req.session.user_email);

    if (!date || !service_id) {
      return res.status(400).json({ error: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£' });
    }

    const [bookedTimes] = await pool.query(
      `SELECT time_booking FROM booking 
       WHERE booking_date = ? AND service_id = ?`,
      [date, service_id]
    );

    const allSlots = ['09:00', '10:00', '11:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00'];
    const availableSlots = allSlots.filter(time => 
      !bookedTimes.some(booked => booked.time_booking === time)
    );

    res.json({
      date,
      service_id,
      available_slots: availableSlots
    });
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå' });
  }
});

// API: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô‡∏´‡∏°‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö users)
app.get('/api/vet-availability', async (req, res) => {
  try {
    const { date, vet_id } = req.query;
    const email = req.session?.user_email || 'default@example.com';
    const pool = getPoolPromise(email);
    
    if (!date) {
      return res.status(400).json({ error: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' });
    }
    
    let query = 'SELECT vet_id, closed_date FROM vet_closed_days WHERE closed_date = ?';
    let params = [date];
    
    if (vet_id) {
      query += ' AND vet_id = ?';
      params.push(vet_id);
    }
    
    const [closedResults] = await pool.query(query, params);
    const closedVets = closedResults.map(row => row.vet_id);
    
    // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const [allVets] = await pool.query('SELECT vet_id, vet_name FROM veterinarian');
    
    const availability = allVets.map(vet => ({
      vet_id: vet.vet_id,
      vet_name: vet.vet_name,
      is_available: !closedVets.includes(vet.vet_id)
    }));
    
    res.json({
      date,
      vets: availability,
      available_vets: availability.filter(v => v.is_available)
    });
    
  } catch (error) {
    console.error('Error checking vet availability:', error);
    res.status(500).json({ error: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' });
  }
});

const port = 3000;
app.listen(port, () => {
  console.log(`Server running at http://localhost:${port}`);
});
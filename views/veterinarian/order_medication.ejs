<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <title>จ่ายยา - <%= booking.pet_name %>
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <%- include('../partials/link') %>

</head>

<body>
  <div class="container py-3">
    <%- include('../partials/header_vet') %>
    <div class="flex justify-end mt-4">
  <button type="button" 
          class="btn btn-cancel "
          onclick="location.href='/veterinarian/pet_order'">
    กลับ
  </button>
</div>

      <div>
        <center>
        <strong class="text-2xl ">
      <i class="fas fa-edit text-primary2"></i>
      จ่ายยา
    </strong></center>
          
        <div>
        </div>
      </div>
      
      <p class="text-center text-lg">
            สัตวแพทย์: <%= vetName %> |
              Treatment ID: <%= treatmentId %> |
                Booking ID: <%= booking.booking_id %>
          </p><br>

      <!-- ข้อมูลพื้นฐาน -->
    
       <div class="border border-edit rounded p-4  bg-gray-50">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-lg">
    <div><strong>เจ้าของ:</strong> <%= booking.owner_name %></div>
    <div><strong>สัตว์เลี้ยง:</strong> <%= booking.pet_name %> (<%= booking.pet_type_name %>)</div>
    <div><strong>บริการ:</strong> <%= booking.service_name %> (฿<%= (booking.service_price||0).toFixed(2) %>)</div>
    <div><strong>วันที่:</strong> <%= new Date(booking.booking_date).toLocaleDateString('th-TH') %></div>
    <div><strong>เวลา:</strong> <%= booking.time_booking %></div>
    <div><strong>สถานะ:</strong> <%= booking.status %></div>
  </div>
</div>


      <!-- รายการยาที่จ่ายแล้ว + ปุ่มเพิ่ม -->
      <div class="card mb-3">
        <h1 class="text-xl">
          รายการยาที่สั่ง
        </h1>
       <div class="card-body">
  <div id="dispensed-list">
    <% if (dispensedMeds && dispensedMeds.length > 0) { %>
      <div class="w-full">
        <table class="w-full ">
          <thead class="">
            <tr>
              <th class="tb-g1">ยา</th>
              <th class="tb-g2">บรรจุภัณฑ์</th>
              <th class="tb-g3">ราคา/หน่วย</th>
              <th class="tb-g4">จำนวน</th>
              <th class="tb-g5">รวม</th>
              <th class="tb-g6">จัดการ</th>
            </tr>
          </thead>
          <tbody>
            <% dispensedMeds.forEach(function(d){ %>
              <tr data-dispens-id="<%= d.dispens_id %>">
                <td class="px-4 py-3 border-b border-gray-200 text-center"><%= d.medicine_name %></td>
                <td class="px-4 py-3 border-b border-gray-200 text-center"><%= d.medicine_package %></td>
                <td class="px-4 py-3 border-b border-gray-200 text-center">฿<%= (+d.medicine_price).toFixed(2) %></td>
                <td class="px-4 py-3 border-b border-gray-200 text-center"><%= d.quantity %></td>
                <td class="px-4 py-3 border-b border-gray-200 text-center">฿<%= (+d.total_price).toFixed(2) %></td>
                <td class="px-4 py-3 border-b border-gray-200 text-center">
                  <button type="button" 
                          class="btn btn-sm btn-delete"
                          onclick="removeDispens('<%= d.dispens_id %>')">
                    ลบ
                  </button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <div class="text-muted">ยังไม่มีรายการยาที่จ่าย</div>
    <% } %>
  </div>
</div>

        <button type="button" onclick="toggleMenu()" class="btn btn-add w-full txet-lg">
          + เพิ่มยา
        </button>
      </div>





      <!-- ตะกร้ารอยืนยัน -->
      <div id="cartCard" class="card mb-3 border border-b1 p-3 " style="display:none;">
        <div class="tb-b1">รายการยาที่เลือกไว้</div>
        <div class="card-body">
          <div id="cartList"></div>
          <div class="d-flex justify-content-between align-items-center mt-3">
            <div><strong>ค่ายารวม: ฿<span id="cartTotal">0.00</span></strong></div>
            <div class="flex justify-end">
              <button type="button" class="btn btn-cancel" onclick="clearCart()">ล้าง</button>
             <button type="button" class="btn btn-success" id="saveCartBtn">
  บันทึกทั้งหมด
</button>

            </div>
          </div>
        </div>
      </div>

      <!-- ปุ่มเปิดเมนูยา -->


    <!-- เมนูยา (collapse) -->
<div id="addMedicineSection" class="hidden border rounded p-2 bg-white shadow">
  <div class="mb-2">
    <input type="text" id="medicineSearch" class="w-full form-input" placeholder="ค้นหาด้วยชื่อยา...">
  </div>
  <div class="overflow-auto max-h-80 border rounded">
    <% if (medication && medication.length > 0) { %>
      <table class="w-full table-auto border-collapse">
        <thead class="bg-gray-100 sticky top-0">
          <tr>
            <th class="px-3 py-2 text-left">ชื่อยา / แพ็กเกจ</th>
            <th class="px-3 py-2 text-right">ราคา/หน่วย</th>
            <th class="px-3 py-2 text-right">คงเหลือ</th>
            <th class="px-3 py-2 text-center w-20">จำนวน</th>
            <th class="px-3 py-2 text-center w-24">จัดการ</th>
          </tr>
        </thead>
        <tbody id="medicineList">
          <% medication.forEach(m => { %>
            <tr data-medication-id="<%= m.medication_id %>" class="border-b hover:bg-gray-50">
              <td class="px-3 py-2">
                <span class="medicine-name font-semibold"><%= m.medicine_name %></span><br>
                <small class="text-gray-500"><%= m.medicine_package %></small>
              </td>
              <td class="px-3 py-2 text-right">฿<span class="price"><%= m.medicine_price %></span></td>
              <td class="px-3 py-2 text-right"><span class="stock"><%= m.stock_quantity %></span></td>
              <td class="px-3 py-2 text-center">
                <input type="number" class="qty-input border rounded px-2 py-1 w-16 mx-auto" 
                       value="1" min="1" max="<%= m.stock_quantity %>">
              </td>
              <td class="px-3 py-2 text-center">
                <button type="button" class="btn-add px-5 py-3 bg-green-500 text-white rounded hover:bg-green-600 add-to-cart">
                  เพิ่ม
                </button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } else { %>
      <div class="text-gray-400 text-sm p-2">ไม่มีข้อมูลยา</div>
    <% } %>
  </div>
</div>




      <!-- สรุปทั้งหมด -->
       
      <div class="card bg-edit p-4">
        
          <div  style="display: flex; justify-content: space-between;"> 
          <div >ค่าบริการ: ฿<%= (booking.service_price||0).toFixed(2) %>
          </div>
          <div style="padding-left: 15%;">ค่ายา: ฿<%= (medicineTotal||0).toFixed(2) %>
          </div>
          <div style="padding-left: 15%;"><strong>รวมสุทธิ: ฿<%= (grandTotal||0).toFixed(2) %></strong></div>
        </div>
</div>
  </div>

  <input type="hidden" id="treatmentId" value="<%= treatmentId %>">

  <script>
    async function saveBatch() {
  if (cart.length === 0) {
    alert('ยังไม่มีรายการยาในตะกร้า');
    return;
  }

  const btn = document.getElementById('saveCartBtn');
  btn.disabled = true;
  btn.textContent = 'กำลังบันทึก...';

  try {
    const treatmentId = document.getElementById('treatmentId').value;

    const payload = {
      treatment_id: treatmentId,
      medications: cart.map(i => ({
        medication_id: i.medication_id,
        quantity: i.qty
      }))
    };

    const res = await fetch('/veterinarian/order_medication/save_medications_batch', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const json = await res.json();

    if (!json.success) {
      alert(json.message || 'บันทึกไม่สำเร็จ');
      btn.disabled = false;
      btn.textContent = 'บันทึกทั้งหมด';
      return;
    }

    alert(json.message || 'บันทึกเรียบร้อย');
    // ล้างตะกร้าหรือ reload หน้า
    clearCart();
    location.reload();

  } catch (err) {
    alert('เกิดข้อผิดพลาด: ' + err.message);
    btn.disabled = false;
    btn.textContent = 'บันทึกทั้งหมด';
  }
}

async function removeDispens(dispensId) {
  if (!confirm('ยืนยันการลบยาที่จ่ายแล้วใช่หรือไม่?')) return;

  try {
    const res = await fetch(`/veterinarian/order_medication/remove_medication/${dispensId}`, {
      method: 'DELETE',
      headers: {
        'Accept': 'application/json' // บอก server ว่าเราต้องการ JSON
      },
      credentials: 'same-origin' // ถ้าใช้ session/cookie (same origin)
    });

    const contentType = res.headers.get('content-type') || '';

    // ถ้า server ตอบเป็น JSON
    if (contentType.includes('application/json')) {
      const json = await res.json();
      if (res.ok && json.success) {
        alert(json.message || 'ลบสำเร็จ');
        location.reload();
      } else {
        alert(json.message || `ลบไม่สำเร็จ (status ${res.status})`);
      }
      return;
    }

    // ถ้าไม่ใช่ JSON: อ่าน text เพื่อดีบั๊ก (โดยมากคือ HTML หน้า login / error)
    const text = await res.text();
    console.error('Server response (not JSON):', res.status, text);
    if (res.status === 302 || /<form.+login/i.test(text) || /<title>.*login/i.test(text) ) {
      alert('เซิร์ฟเวอร์ตอบเป็นหน้า HTML (น่าจะถูก redirect ไปหน้า login). ลองเช็คการล็อกอิน/คุกกี้');
    } else {
      alert(`Server ตอบเป็น HTML/text (status ${res.status}). ดู console.log สำหรับรายละเอียด`);
    }
  } catch (err) {
    console.error('removeDispens error', err);
    alert('เกิดข้อผิดพลาด: ' + err.message);
  }
}


// bind ปุ่ม หลังโหลด DOM
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('saveCartBtn');
  if (btn) {
    btn.addEventListener('click', saveBatch);
  }
});
const cart = []; // {medication_id, name, price, package, stock, qty}

// แสดง/ซ่อนเมนูยา
function toggleMenu() {
  document.getElementById("addMedicineSection").classList.toggle("hidden");
}

// รีเฟรชตะกร้า
function refreshCartUI() {
  const card = document.getElementById('cartCard');
  const list = document.getElementById('cartList');
  const totalEl = document.getElementById('cartTotal');

  if (cart.length === 0) {
    card.style.display = 'none';
    list.innerHTML = '';
    totalEl.textContent = '0.00';
    return;
  }

  card.style.display = 'block';

  list.innerHTML = cart.map(item => `
    <div class="flex items-center justify-between border-b py-2" data-medication-id="${item.medication_id}">
      <div class="flex-1">
        <strong>${item.name}</strong>
        <p class="text-sm text-gray-500">${item.package}</p>
      </div>
      <div class="w-24 text-right">฿${(+item.price * item.qty).toFixed(2)}</div>
      <div class="flex items-center space-x-2 w-32">
        <button type="button" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300"
                onclick="changeQty('${item.medication_id}', -1, ${item.stock})">−</button>
        <input type="number" id="qty-${item.medication_id}" class="border rounded w-16 text-center"
               value="${item.qty}" min="1" max="${item.stock}" onchange="updateQty('${item.medication_id}', this.value)">
        <button type="button" class="px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600"
                onclick="changeQty('${item.medication_id}', 1, ${item.stock})">+</button>
      </div>
      <div>
        <button type="button" class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600"
                onclick="removeFromCart('${item.medication_id}')">ลบ</button>
      </div>
    </div>
  `).join('');

  const total = cart.reduce((sum, i) => sum + (+i.price * i.qty), 0);
  totalEl.textContent = total.toFixed(2);
}

function changeQty(id, delta, max) {
const input = document.getElementById(`qty-${id}`);

  if (!input) return;
  let val = parseInt(input.value) + delta;
  if (val < 1) val = 1;
  if (val > max) val = max;
  input.value = val;
  updateQty(id, val);
}

// อัพเดตจำนวน
function updateQty(id, val) {
  const item = cart.find(x => x.medication_id === id);
  if (!item) return;
  const q = parseInt(val);
  if (!q || q < 1) return;
  if (q > item.stock) { alert('จำนวนเกินสต็อก'); return; }
  item.qty = q;
  refreshCartUI();
}

// ลบจากตะกร้า
function removeFromCart(id) {
  const idx = cart.findIndex(x => x.medication_id === id);
  if (idx > -1) { cart.splice(idx, 1); refreshCartUI(); }
}

// ล้างตะกร้า
function clearCart() {
  cart.length = 0;
  refreshCartUI();
}

// เพิ่มยาเข้า cart
function addToCart(row) {
  const id = row.getAttribute('data-medication-id');
  const name = row.querySelector('.medicine-name').textContent.trim();
  const price = parseFloat(row.querySelector('.price').textContent.trim());
  const pkg = row.querySelector('small.text-gray-500')?.textContent.trim() || '';
  const stock = parseInt(row.querySelector('.stock').textContent.trim());
  const qtyInput = row.querySelector('.qty-input');
  const qty = parseInt(qtyInput.value);

  if (!qty || qty < 1) { alert('กรุณาใส่จำนวนให้ถูกต้อง'); return; }
  if (qty > stock) { alert('จำนวนเกินสต็อก'); return; }
  if (cart.find(x => x.medication_id === id)) { alert('มีรายการนี้ในตะกร้าแล้ว'); return; }

  cart.push({ medication_id: id, name, price, package: pkg, stock, qty });
  refreshCartUI();
}

// Bind ปุ่ม + เพิ่มยา


document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.add-to-cart').forEach(btn => {
    btn.addEventListener('click', function() {
      const row = this.closest('tr');
      if (!row) return;
      addToCart(row);
    });
  });
});


// ค้นหา
document.getElementById('medicineSearch')?.addEventListener('input', function() {
  const q = this.value.toLowerCase();
  document.querySelectorAll('#medicineList tr').forEach(row => {
    const name = row.querySelector('.medicine-name').textContent.toLowerCase();
    row.style.display = name.includes(q) ? '' : 'none';
  });
});
</script>

</body>

</html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>จัดการวันเปิดทำการของหมอ</title>
  <%- include('../partials/link') %>
</head>
<body>

  <div class="container ">
    <%- include('../partials/header_vet') %>

    <p class="mb-2 text-sm text-text">รหัสคุณหมอ: <%= vetId %></p>
    <h1 class="text-2xl font-bold flex items-center gap-2 mb-6">
      <i class="fas fa-calendar-alt text-primary2"></i> 
      จัดการวันเปิดทำการของคุณหมอ
    </h1>

    <!-- Add New Work Days Form -->
    <div class="form-info rounded-xl shadow-md p-6 mb-6">
      <h3 class="text-lg font-semibold flex items-center gap-2 mb-4">
        <i class="fas fa-plus-circle text-green-600"></i> เพิ่มวันทำงานใหม่
      </h3>
      <form method="POST" action="/veterinarian/work_days/add" class="space-y-4"> 
        <input type="hidden" name="vet_id" value="<%= vetId %>">
        
 <!-- Date Filter -->

        <div>
          <label class="block text-gray-700 mb-1">เลือกวันที่:</label>
          <div class="relative">
            <input type="text" id="datepicker" name="work_dates" required 
                   class="w-full form-input px-3 py-2 focus:ring-2 focus:ring-primary2">
            <i class="fa-solid fa-calendar-days text-xl absolute right-3 top-2.5 text-primary2"></i>
          </div>
        </div>

        <div class="flex gap-4">
          <div class="flex-1">
            <label class="block text-gray-700 mb-1">เวลาเริ่ม:</label>
            <input type="time" id="start_time" name="start_time" value="09:00" required
                   class="w-full form-input px-3 py-2 focus:ring-2 focus:ring-primary2">
          </div>
          <div class="flex-1">
            <label class="block text-gray-700 mb-1">เวลาสิ้นสุด:</label>
            <input type="time" id="end_time" name="end_time" value="17:00" required
                   class="w-full form-input px-3 py-2 focus:ring-2 focus:ring-primary2">
          </div>
        </div>

        <button type="submit" 
                class="w-full btn btn-add">
          <p><i class="fas fa-save"></i>  บันทึก</p>
        </button>
      </form>
    </div>

    <!-- Calendar View -->
    <h3 class="text-2xl font-semibold flex items-center gap-2 mb-4">
      <i class="fas fa-business-time text-indigo-600"></i> ตารางงานของคุณ
    </h3>

    <div class="overflow-x-auto rounded-lg shadow max-h-[450px] p-2 bg-white">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <% if (schedule && schedule.length > 0) { %>
          <% schedule.forEach((work, index) => { %>
            <div class="bg-white border rounded-xl shadow p-4 flex flex-col gap-3 hover:shadow-md transition">
              <div class="font-semibold text-gray-800 flex items-center gap-2">
                <i class="fas fa-calendar-day text-primary2"></i>
                <%= new Date(work.work_day).toLocaleDateString("th-TH", { 
                  weekday: 'long', 
                  year: 'numeric', 
                  month: 'long', 
                  day: 'numeric' 
                }) %>
              </div>

              <div class="text-gray-600 flex items-center gap-2" id="display-<%= work.work_id %>">
                <i class="fas fa-clock text-indigo-500"></i>
                <%= work.start_time.slice(0,5) %> - <%= work.end_time.slice(0,5) %> น.
              </div>

              <div class="hidden gap-2" id="edit-<%= work.work_id %>">
                <input type="time" id="start-<%= work.work_id %>" 
                       value="<%= work.start_time.slice(0,5) %>"
                       class="border rounded px-2 py-1">
                <span>-</span>
                <input type="time" id="end-<%= work.work_id %>" 
                       value="<%= work.end_time.slice(0,5) %>"
                       class="border rounded px-2 py-1">
              </div>

              <div class="flex gap-2 mt-auto">
                <button class="flex-1 bg-edit text-white py-2 rounded-lg hover:opacity-90 transition"
                        id="edit-btn-<%= work.work_id %>"
                        onclick="editWorkTime(<%= work.work_id %>)">
                  <i class="fas fa-edit"></i> แก้ไข
                </button>
                <button class="hidden flex-1 bg-green-600 text-white py-2 rounded-lg hover:opacity-90 transition"
                        id="save-btn-<%= work.work_id %>"
                        onclick="saveWorkTime(<%= work.work_id %>)">
                  <i class="fas fa-save"></i> บันทึก
                </button>
                <button class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:opacity-90 transition"
                        onclick="deleteWorkDay(<%= work.work_id %>, '<%= new Date(work.work_day).toLocaleDateString("th-TH") %>', '<%= vetId %>')">
                  <i class="fas fa-trash"></i> ลบ
                </button>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div class="col-span-full text-center text-gray-500 py-12">
            <i class="fas fa-calendar-times text-4xl mb-3"></i>
            <p>ยังไม่มีวันทำงานที่กำหนดไว้</p>
            <p class="text-sm">เพิ่มวันทำงานเพื่อให้ลูกค้าสามารถจองได้</p>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- flatpickr -->
<script src="/js/calendar_select.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
  // รับข้อมูลวันที่ที่ถูกใช้แล้วจาก server
  const disabledDates = <%-disabledDates || '[]' %>;
  
  console.log('Disabled dates:', disabledDates); // Debug
  
  flatpickr("#datepicker", {
    mode: "multiple",
    dateFormat: "Y-m-d",
    minDate: "today",
    disable: disabledDates, // ป้องกันไม่ให้เลือกวันที่ซ้ำ
    onDayCreate: function(dObj, dStr, fp, dayElem) {
      // เพิ่ม class หรือ style ให้กับวันที่ที่ถูก disable
      if (dayElem.dateObj) {
        // ใช้ UTC เพื่อหลีกเลี่ยงปัญหา timezone
        const year = dayElem.dateObj.getFullYear();
        const month = String(dayElem.dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dayElem.dateObj.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;
        
        console.log('Checking date:', dateStr, 'in disabled list:', disabledDates.includes(dateStr)); // Debug
        
        if (disabledDates.includes(dateStr)) {
          dayElem.style.backgroundColor = '#ffebee';
          dayElem.style.color = '#c62828';
          dayElem.style.textDecoration = 'line-through';
          dayElem.title = 'วันที่นี้ถูกใช้แล้ว';
        }
      }
    },
    locale: {
      firstDayOfWeek: 1, // เริ่มต้นจากวันจันทร์
      weekdays: {
        shorthand: ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'],
        longhand: ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์']
      },
      months: {
        shorthand: ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'],
        longhand: ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม']
      }
    }
  });

  function editWorkTime(id) {
    document.getElementById(`display-${id}`).style.display = "none";
    document.getElementById(`edit-${id}`).style.display = "flex";
    document.getElementById(`edit-btn-${id}`).style.display = "none";
    document.getElementById(`save-btn-${id}`).style.display = "inline-block";
    document.getElementById(`cancel-btn-${id}`).style.display = "inline-block";
  }

  function cancelEdit(id) {
    document.getElementById(`display-${id}`).style.display = "block";
    document.getElementById(`edit-${id}`).style.display = "none";
    document.getElementById(`edit-btn-${id}`).style.display = "inline-block";
    document.getElementById(`save-btn-${id}`).style.display = "none";
    document.getElementById(`cancel-btn-${id}`).style.display = "none";
  }

  function saveWorkTime(id) {
    const start_time = document.getElementById(`start-${id}`).value;
    const end_time = document.getElementById(`end-${id}`).value;

    fetch(`/veterinarian/work_days/update/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ start_time, end_time })
    }).then(res => {
      if (res.ok) location.reload();
      else alert("อัปเดตเวลาไม่สำเร็จ");
    });
  }

  function deleteWorkDay(id, dateLabel, vetId) {
  if (confirm(`ต้องการลบตารางงานวันที่ ${dateLabel} ใช่หรือไม่?`)) {
    window.location.href = `/veterinarian/work_days/delete/${id}?vet_id=${vetId}`;
  }
}

</script>

<style>
/* เพิ่ม CSS สำหรับ disabled dates */
.flatpickr-day.flatpickr-disabled {
  background-color: #ffebee !important;
  color: #c62828 !important;
  text-decoration: line-through !important;
  cursor: not-allowed !important;
}

.flatpickr-day.flatpickr-disabled:hover {
  background-color: #ffcdd2 !important;
}
</style>

</body>
</html>
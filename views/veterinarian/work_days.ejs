<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>จัดการวันเปิดทำการของหมอ</title>
  <%- include('../partials/link') %>
<!--    -->
  <style>
    .work-schedule-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.work-day-card {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.work-day-date {
  font-weight: bold;
  color: #2c3e50;
  display: flex;
  align-items: center;
  gap: 8px;
}

.work-time-display,
.work-time-edit {
  font-size: 1rem;
  color: #555;
  display: flex;
  align-items: center;
  gap: 8px;
}

.work-time-edit input[type="time"] {
  padding: 6px 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
}

.card-actions {
  margin-top: auto;
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.btn-card {
  flex: 1;
  padding: 8px;
  border-radius: 8px;
  font-size: 0.9rem;
  border: none;
  cursor: pointer;
  transition: 0.2s;
}

.btn-edit   { background: #3498db; color: #fff; }
.btn-save   { background: #27ae60; color: #fff; }
.btn-cancel { background: #95a5a6; color: #fff; }
.btn-delete { background: #e74c3c; color: #fff; }

.btn-card:hover { opacity: 0.85; }

  </style>
</head>
<body>

  <div class="container">
    <%- include('../partials/header_vet') %>
    <p>รหัสคุณหมอ: <%= vetId %></p>
    <h1><i class="fas fa-calendar-alt"></i> จัดการวันเปิดทำการของคุณหมอ</h1>

    <!-- Add New Work Days Form -->
    <div class="form-section">
      <h3><i class="fas fa-plus-circle"></i> เพิ่มวันทำงานใหม่</h3>
      <form method="POST" action="/veterinarian/work_days/add" > 
        <input type="hidden" name="vet_id" value="<%= vetId %>">
        
          <div class="form-group">
            <label>เลือกวันที่:</label>
            <div style="position: relative; " >
              <input type="text" id="datepicker" name="work_dates" required>
              <i class="fa-solid fa-calendar-days calendar-icon"></i>
            </div>
          </div>

<div style="display: flex;gap: 10px;" >
          <div class="form-group" >
            <label>เวลาเริ่ม:</label>
            <input type="time" id="start_time" name="start_time" value="09:00" required>
          </div>
          <div ></div>
          <div class="form-group">
            <label >เวลาสิ้นสุด:</label>
            <input type="time" id="end_time" name="end_time" value="17:00" required>
          </div>
          </div>
          
          
          <br>
            <button type="submit" class="btn-primary" style="width: 100%;">
              <i class="fas fa-save"></i> บันทึก
            </button>
        
      </form>
    </div>

    <!-- Calendar View -->
    <!-- <div class="calendar-container"> -->
      <!-- <div class="calendar-section"> -->
        <h3><i class="fas fa-business-time"></i> ตารางงานของคุณ</h3><br>

        <div class="overflow-x-auto rounded-lg shadow" style="height: 500px;">
        <div class="work-schedule-grid" >
          <% if (schedule && schedule.length > 0) { %>
            <% schedule.forEach((work, index) => { %>
              <div class="work-day-card">
                <div class="work-day-date">
                  <i class="fas fa-calendar-day"></i>
                  <%= new Date(work.work_day).toLocaleDateString("th-TH", { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                  }) %>
                </div>
                
                <div class="work-time-display" id="display-<%= work.work_id %>">
                  <i class="fas fa-clock"></i>
                  <%= work.start_time.slice(0,5) %> - <%= work.end_time.slice(0,5) %> น.
                </div>
                
                <div class="work-time-edit" id="edit-<%= work.work_id %>">
                  <input type="time" id="start-<%= work.work_id %>" value="<%= work.start_time.slice(0,5) %>">
                  <span style="color: rgba(255,255,255,0.8);">-</span>
                  <input type="time" id="end-<%= work.work_id %>" value="<%= work.end_time.slice(0,5) %>">
                </div>
                
                <div class="card-actions">
                  <button class="btn-card btn-edit" id="edit-btn-<%= work.work_id %>" 
                          onclick="editWorkTime(<%= work.work_id %>)">
                    <i class="fas fa-edit"></i> แก้ไข
                  </button>
                  <button class="btn-card btn-save" id="save-btn-<%= work.work_id %>" 
                          onclick="saveWorkTime(<%= work.work_id %>)">
                    <i class="fas fa-save"></i> บันทึก
                  </button>
                  <!-- <button class="btn-card btn-cancel" id="cancel-btn-<%= work.work_id %>" 
                          onclick="cancelEdit(<%= work.work_id %>)">
                    <i class="fas fa-times"></i> ยกเลิก
                  </button> -->
                  <button class="btn-card btn-delete" 
        onclick="deleteWorkDay(<%= work.work_id %>, '<%= new Date(work.work_day).toLocaleDateString("th-TH") %>', '<%= vetId %>')">
  <i class="fas fa-trash"></i> ลบ
</button>

                </div>
              </div>
            <% }) %>
          <% } else { %>
            <div style="text-align: center; padding: 2rem; color: #666;">
              <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 1rem;"></i>
              <p>ยังไม่มีวันทำงานที่กำหนดไว้</p>
              <p>เพิ่มวันทำงานเพื่อให้ลูกค้าสามารถจองได้</p>
            </div>
          <% } %>
        <!-- </div> -->
      <!-- </div> -->
    <!-- </div> -->
  </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
  // รับข้อมูลวันที่ที่ถูกใช้แล้วจาก server
  const disabledDates = <%-disabledDates || '[]' %>;
  
  console.log('Disabled dates:', disabledDates); // Debug
  
  flatpickr("#datepicker", {
    mode: "multiple",
    dateFormat: "Y-m-d",
    minDate: "today",
    disable: disabledDates, // ป้องกันไม่ให้เลือกวันที่ซ้ำ
    onDayCreate: function(dObj, dStr, fp, dayElem) {
      // เพิ่ม class หรือ style ให้กับวันที่ที่ถูก disable
      if (dayElem.dateObj) {
        // ใช้ UTC เพื่อหลีกเลี่ยงปัญหา timezone
        const year = dayElem.dateObj.getFullYear();
        const month = String(dayElem.dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dayElem.dateObj.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;
        
        console.log('Checking date:', dateStr, 'in disabled list:', disabledDates.includes(dateStr)); // Debug
        
        if (disabledDates.includes(dateStr)) {
          dayElem.style.backgroundColor = '#ffebee';
          dayElem.style.color = '#c62828';
          dayElem.style.textDecoration = 'line-through';
          dayElem.title = 'วันที่นี้ถูกใช้แล้ว';
        }
      }
    },
    locale: {
      firstDayOfWeek: 1, // เริ่มต้นจากวันจันทร์
      weekdays: {
        shorthand: ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'],
        longhand: ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์']
      },
      months: {
        shorthand: ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'],
        longhand: ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม']
      }
    }
  });

  function editWorkTime(id) {
    document.getElementById(`display-${id}`).style.display = "none";
    document.getElementById(`edit-${id}`).style.display = "flex";
    document.getElementById(`edit-btn-${id}`).style.display = "none";
    document.getElementById(`save-btn-${id}`).style.display = "inline-block";
    document.getElementById(`cancel-btn-${id}`).style.display = "inline-block";
  }

  function cancelEdit(id) {
    document.getElementById(`display-${id}`).style.display = "block";
    document.getElementById(`edit-${id}`).style.display = "none";
    document.getElementById(`edit-btn-${id}`).style.display = "inline-block";
    document.getElementById(`save-btn-${id}`).style.display = "none";
    document.getElementById(`cancel-btn-${id}`).style.display = "none";
  }

  function saveWorkTime(id) {
    const start_time = document.getElementById(`start-${id}`).value;
    const end_time = document.getElementById(`end-${id}`).value;

    fetch(`/veterinarian/work_days/update/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ start_time, end_time })
    }).then(res => {
      if (res.ok) location.reload();
      else alert("อัปเดตเวลาไม่สำเร็จ");
    });
  }

  function deleteWorkDay(id, dateLabel, vetId) {
  if (confirm(`ต้องการลบตารางงานวันที่ ${dateLabel} ใช่หรือไม่?`)) {
    window.location.href = `/veterinarian/work_days/delete/${id}?vet_id=${vetId}`;
  }
}

</script>

<style>
/* เพิ่ม CSS สำหรับ disabled dates */
.flatpickr-day.flatpickr-disabled {
  background-color: #ffebee !important;
  color: #c62828 !important;
  text-decoration: line-through !important;
  cursor: not-allowed !important;
}

.flatpickr-day.flatpickr-disabled:hover {
  background-color: #ffcdd2 !important;
}
</style>

</body>
</html>
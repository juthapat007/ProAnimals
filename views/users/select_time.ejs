<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>จองคิวบริการ - เลือกเวลา</title>
  <%- include('../partials/link') %>
</head>
<body >
  <div class="container">
    <%- include('../partials/header') %>
    <%- include('../partials/numberBar', { step: 3 }) %>

    <form action="/users/confirm" method="post" id="bookingForm" class="space-y-6">
    
      <!-- วันที่ -->
      <p class="text-xl  text-primary2">
        วันที่: <span class="text-text"><%= date %></span>
      </p>
      <input type="hidden" name="date" value="<%= date %>">

      <!-- Service Info -->
      <div class="bg-white p-3 border-2 border-primary2 rounded-lg " style="display: flex; justify-content: space-between;">
        <strong class="text-lg"><%= service.service_type %></strong>
        <span class="text-lg"><strong>ราคา:</strong> <%= service.service_price %> บาท</span>
        <span class="text-lg">
          <strong>ระยะเวลา:</strong>
          <%= Math.floor(serviceDurationMinutes / 60) %> ชั่วโมง 
          <%= serviceDurationMinutes % 60 %> นาที
        </span>
      </div>

      <!-- เลือกเวลา -->
      <div>
        <h3 class="text-xl mb-3">เลือกเวลา <span class="text-red">*</span></h3>

        <!-- Legend -->
        <div class="flex flex-wrap gap-4 mb-4">
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded bg-add border-spacing-2"></div><span>ว่าง</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded bg-gray-400"></div><span>ถูกจองแล้ว</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded bg-primary2"></div><span>เลือกแล้ว</span>
          </div>
        </div>
      </div>

      <input type="hidden" name="cus_id" value="<%= cus_id %>">
      <input type="hidden" name="pet_id" value="<%= pet_id %>">
      <input type="hidden" name="service_id" value="<%= service_id %>">
      <input type="hidden" name="time" id="selectedTimeInput" required />

      <!-- Time Slots -->
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
        <% allSlots.forEach(slot => { 
            const isAvailable = availableSlots.includes(slot);
            const slotEndTime = (() => {
              const startMinutes = Math.floor(parseInt(slot.split(':')[0])) * 60 + parseInt(slot.split(':')[1]);
              const endMinutes = startMinutes + serviceDurationMinutes;
              const hours = Math.floor(endMinutes / 60);
              const mins = endMinutes % 60;
              return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            })();
        %>
          <div 
  class="time-slot p-4 text-center  rounded-custom border-2 transition
         <%= isAvailable 
             ? 'border-success bg-add hover:bg-accent hover:scale-105 available' 
             : 'border-gray-300 bg-gray-200 booked cursor-not-allowed' %>"
  data-time="<%= slot %>"
  data-available="<%= isAvailable %>"
>

            <div class="time-main  text-lg"><%= slot %></div>
            <div class="time-end text-sm text-gray-600">ถึง <%= slotEndTime %></div>
            <div class="time-duration text-xs text-gray-500">
              (<%= Math.floor(serviceDurationMinutes / 60) %>:<%= String(serviceDurationMinutes % 60).padStart(2, '0') %> ชม.)
            </div>
          </div>
        <% }) %>
      </div>

      <% if (availableSlots.length === 0) { %>
        <div class="bg-red-100 text-red-700 text-center p-4 rounded-custom shadow-custom">
          <p><strong>ขออภัย ไม่มีช่วงเวลาว่างสำหรับบริการนี้ในวันที่เลือก</strong></p>
          <p>กรุณาเลือกวันอื่น หรือบริการอื่น</p>
        </div>
      <% } %>

      <!-- Buttons -->
      <div class="space-y-4">
        <button type="submit" id="nextButton" class="btn-primary w-full h-14" disabled style=" height: 60px;">
          ถัดไป  <i class="fas fa-arrow-right mr-2"></i>
        </button>
        <button type="button" class="btn-cancel w-full h-14" style=" height: 60px;" onclick="history.back()">
          <i class="fas fa-arrow-left mr-2"></i> ย้อนกลับ
        </button>
      </div>
    </form>
  </div>

  <script>
document.addEventListener('DOMContentLoaded', function() {
  const timeSlots = document.querySelectorAll('.time-slot.available');
  const nextButton = document.getElementById('nextButton');
  const selectedTimeInput = document.getElementById('selectedTimeInput');

  timeSlots.forEach(slot => {
    slot.addEventListener('click', function() {
      // ลบ selected จาก slot อื่น
      timeSlots.forEach(s => s.classList.remove('selected'));

      // เพิ่ม selected ให้ slot ที่คลิก
      this.classList.add('selected');

      // อัพเดท input และ enable ปุ่ม
      selectedTimeInput.value = this.dataset.time;
      nextButton.disabled = false;
    });
  });
});


      const timeSlots = document.querySelectorAll('.time-slot.available');

  timeSlots.forEach(slot => {
    slot.addEventListener('click', () => {
      // ลบ selected จาก slot อื่น (ถ้าต้องเลือกได้แค่ 1)
      timeSlots.forEach(s => s.classList.remove('selected'));

      // เพิ่ม selected ให้ slot ที่คลิก
      slot.classList.add('selected');
    });
  });
  </script>
</body>
</html>

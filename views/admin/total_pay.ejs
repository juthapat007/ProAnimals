<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>คำนวดค่าบริการ - ไชยปราการสัตวแพทย์</title>
    <%- include('../partials/link') %>


</head>

<body>
  <div class="container" style="width: 80%">
    <%- include('../partials/header_admin') %>
<center>
    <strong class="text-2xl ">
    <i class="fas fa-calculator text-primary2"></i>  คำนวนเงินที่ต้องชำระ
  </strong>
  </center>

    <!-- บริการหลัก -->
    <div class="container  rounded-xl shadow-md p-6 mb-6">
  <h2 class="text-2xl font-bold text-text flex items-center mb-3">
     บริการหลัก
  </h2>
  <p class="mb-1">บริการที่เลือก: 
    <span class="font-semibold text-gray-700" id="service-name"><%= booking.service_name || 'ตรวจสุขภาพ' %></span>
  </p>
  <p>ราคา: 
    <span class="font-semibold text-green-600" id="service-price" data-price="<%= booking.service_price || 0 %>">
      ฿<%= (booking.service_price || 0).toFixed(2) %>
    </span>
  </p>
</div>

    <!-- ยาที่จ่ายแล้ว -->
<div class="bg-green-50 rounded-xl shadow-md p-6 mb-6">
  <h2 class="text-2xl font-bold text-text ">

        <i class="fas fa-pills text-primary2"></i>  รายการจ่ายยา
      </h2>
      <div id="dispensed-list">
        <% if (dispensedMeds && dispensedMeds.length > 0) { %>
          <div class="overflow-x-auto">
            <table class="w-full border-collapse rounded-lg overflow-hidden">
              <thead>
                <tr class="bg-green-600 text-white text-left">
                  <th class="tb-g1">ชื่อยา</th>
                  <th class="tb-g2">บรรจุภัณฑ์</th>
                  <th class="tb-g3">ราคา/หน่วย</th>
                  <th class="tb-g4">จำนวน</th>
                  <th class="tb-g5">รวม</th>
                </tr>
              </thead>
              <tbody>
                <% let medicineTotal = 0; %>
                <% dispensedMeds.forEach(function(d){ %>
                  <% medicineTotal += parseFloat(d.total_price); %>
                  <tr class="bg-white border-b">
                    <td class="px-4 py-3"><%= d.medicine_name %></td>
                    <td class="px-4 py-3"><%= d.medicine_package %></td>
                    <td class="px-4 py-3 text-right">฿<%= (+d.medicine_price).toFixed(2) %></td>
                    <td class="px-4 py-3 text-center"><%= d.quantity %></td>
                    <td class="px-4 py-3 text-right">฿<%= (+d.total_price).toFixed(2) %></td>
                    
                  </tr>
                <% }) %>
              </tbody>
              <tfoot>
                <tr class="font-bold bg-gray-100">
                  <td colspan="4" class="px-4 py-3 text-right">รวมค่ายา:</td>
                  <td class="px-4 py-3 text-right text-green-700">฿<%= medicineTotal.toFixed(2) %></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        <% } else { %>
          <p class="text-gray-500 italic">ยังไม่มีรายการยาที่จ่าย</p>
        <% } %>
      </div>
    </div>

    <!-- สรุปยอดรวม -->
<div class="bg-edit/40 border border-color-edit rounded-xl shadow-md p-6 mb-6">
  <h2 class="text-2xl font-bold text-text mb-3">สรุปค่าใช้จ่าย</h2>
      <div class="space-y-2">
        <div class="flex justify-between">
          <span>ค่าบริการหลัก:</span>
          <span id="summary-service-price"><%= (booking.service_price || 0).toFixed(2) %> บาท</span>
        </div>
        <div class="flex justify-between">
          <span>ค่ายาที่จ่ายแล้ว:</span>
          <span id="summary-dispensed-price"><%= totalDispensed.toFixed(2) %> บาท</span>
        </div>
        <div class="flex justify-between">
          <span>ค่ายาและอุปกรณ์เพิ่ม:</span>
          <span id="summary-medicine-price">0.00 บาท</span>
        </div>
        <hr class="my-2">
        <div class="flex justify-between text-lg font-bold text-green-700">
          <span>ยอดรวมทั้งสิ้น:</span>
          <span id="summary-total-price"><%= ((booking.service_price || 0) + totalDispensed).toFixed(2) %> บาท</span>
        </div>
      </div>
    </div>

    <!-- ฟอร์มชำระเงิน -->
<div class="bg-info/70 rounded-xl shadow-md p-6">
  <h2 class="text-2xl font-bold text-text mb-3">บันทึกการชำระเงิน <span class="text-red">*</span></h2>
 
      <form id="payment-form" action="/admin/total_pay" method="POST" class="space-y-4">
        <input type="hidden" name="booking_id" value="<%= booking.booking_id %>">
        <input type="hidden" name="medications" id="medications-data" value="[]">

        <div>
          <label for="payment_amount" class="font-semibold">จำนวนเงินที่รับชำระ (บาท):</label>
          <input type="number" id="payment_amount" name="payment_amount" 
                 value="<%= ((booking.service_price || 0) + totalDispensed).toFixed(2) %>" 
                 min="0" step="0.01" required
                 class="form-info">
        </div>

        <div>
          <label for="payment_method" class="font-semibold">วิธีการชำระเงิน:</label>
          <select id="payment_method" name="payment_method" required
                  class="form-info">
            <option value="">-- เลือกวิธีการชำระ --</option>
            <% paymentOptions.forEach(pm => { %>
              <option value="<%= pm %>" <%= currentPayment === pm ? 'selected' : '' %>><%= pm %></option>
            <% }) %>
          </select>
          <% if (paymentDone) { %>
            <p class="text-green-600 font-bold mt-2">✅ คุณได้ชำระเงินแล้ว</p>
          <% } %>
        </div>

        <div>
          <label for="payment_note" class="font-semibold">หมายเหตุการชำระเงิน:</label>
          <input type="text" id="payment_note" name="payment_note" 
                 placeholder="เช่น เงินทอน, หมายเลขอ้างอิง"
                 class="form-info">
        </div>

        <div class="flex justify-end space-x-3 pt-4">
          <button type="button" onclick="goBack()"
                  class="btn btn-cancel">
             ย้อนกลับ
          </button>
          <button type="submit"
                  class="px-6 py-3 rounded-lg bg-green-600 text-white font-semibold hover:bg-green-700">
                  <i class="fas fa-save"></i>
             บันทึกการชำระเงิน
          </button>
        </div>
      </form>
    </div>
  </div>
  </div>

  <script>
    // ตัวแปรสำหรับเก็บรายการยา
    let selectedMedicines = [];
    let servicePrice = parseFloat('<%= booking.service_price || 0 %>');
    let dispensedPrice = parseFloat('<%= totalDispensed || 0 %>'); // ค่ายาที่จ่ายแล้ว

    // ค้นหายา
    const input = document.getElementById('med_search');
    const dropdown = document.getElementById('med_dropdown');

    input.addEventListener('input', function() {
      const keyword = this.value.trim();
      if (!keyword) {
        dropdown.style.display = 'none';
        return;
      }

      fetch(`/admin/total_pay/search?keyword=${encodeURIComponent(keyword)}`)
        .then(res => res.json())
        .then(data => {
          dropdown.innerHTML = '';
          if (data.length === 0) {
            dropdown.style.display = 'none';
            return;
          }

          data.forEach(med => {
            const div = document.createElement('div');
            div.textContent = `${med.medication_id} - ${med.medicine_name} (${med.medicine_price} บาท)`;
            div.addEventListener('click', () => {
              input.value = med.medicine_name;
              dropdown.style.display = 'none';
              
              document.getElementById('med_unit').value = med.medicine_package;
              document.getElementById('med_price').value = med.medicine_price;
              updateMedicineTotal();
              
              input.dataset.selectedMed = JSON.stringify(med);
            });
            dropdown.appendChild(div);
          });

          dropdown.style.display = 'block';
        })
        .catch(err => console.error('Medicine search error:', err));
    });

    // ซ่อน dropdown เมื่อคลิกนอก
    document.addEventListener('click', function(e) {
      if (!input.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });

    // คำนวดราคารวมยา
    function updateMedicineTotal() {
      const quantity = parseInt(document.getElementById('med_num').value) || 0;
      const price = parseFloat(document.getElementById('med_price').value) || 0;
      const total = quantity * price;
      document.getElementById('med_total').textContent = total.toFixed(2);
    }

    document.getElementById('med_num').addEventListener('input', updateMedicineTotal);

    // เพิ่มยาลงรายการ
    function addMedicine() {
      const medSearch = document.getElementById('med_search');
      const quantity = parseInt(document.getElementById('med_num').value);
      const unit = document.getElementById('med_unit').value;
      const price = parseFloat(document.getElementById('med_price').value);

      if (!medSearch.dataset.selectedMed || !quantity || !price) {
        alert('กรุณากรอกข้อมูลยาให้ครบถ้วน');
        return;
      }

      const selectedMed = JSON.parse(medSearch.dataset.selectedMed);
      const totalPrice = quantity * price;

      const medicine = {
        medication_id: selectedMed.medication_id,
        medicine_name: selectedMed.medicine_name,
        quantity: quantity,
        unit: unit,
        unit_price: price,
        total_price: totalPrice
      };

      selectedMedicines.push(medicine);
      updateMedicineDisplay();
      clearMedicineForm();
    }

    // แสดงรายการยาที่เลือก
    function updateMedicineDisplay() {
      const medicineList = document.getElementById('medicine-list');
      medicineList.innerHTML = '';

      let totalMedicinePrice = 0;

      selectedMedicines.forEach((med, index) => {
        totalMedicinePrice += med.total_price;
        
        const div = document.createElement('div');
        div.className = 'medicine-item';
        div.innerHTML = `
          <span>${med.medicine_name} × ${med.quantity} ${med.unit}</span>
          <span>${med.total_price.toFixed(2)} บาท</span>
          <button type="button" onclick="removeMedicine(${index})" style="color: red;">ลบ</button>
        `;
        medicineList.appendChild(div);
      });

      // อัปเดตสรุปราคา
      document.getElementById('summary-medicine-price').textContent = totalMedicinePrice.toFixed(2) + ' บาท';
      const totalPrice = servicePrice + dispensedPrice + totalMedicinePrice;
      document.getElementById('summary-total-price').textContent = totalPrice.toFixed(2) + ' บาท';
      document.getElementById('payment_amount').value = totalPrice.toFixed(2);

      // อัปเดต hidden input
      document.getElementById('medications-data').value = JSON.stringify(selectedMedicines);
    }

    // ลบยา
    function removeMedicine(index) {
      selectedMedicines.splice(index, 1);
      updateMedicineDisplay();
    }

    // ล้างฟอร์มยา
    function clearMedicineForm() {
      document.getElementById('med_search').value = '';
      document.getElementById('med_search').dataset.selectedMed = '';
      document.getElementById('med_num').value = '1';
      document.getElementById('med_unit').value = '';
      document.getElementById('med_price').value = '';
      document.getElementById('med_total').textContent = '0.00';
    }

    // ย้อนกลับ
function goBack() {
  if (confirm('คุณต้องการย้อนกลับหรือไม่? ข้อมูลที่ยังไม่ได้บันทึกจะหายไป')) {
    // ซ่อนข้อความ success ก่อน
    // const successMsg = document.getElementById('success');
    // if (successMsg) successMsg.style.display = 'none';

    window.location.href = '/admin/mg_queue';
  }
}


    // ลบยาที่จ่ายแล้ว
    async function removeDispens(dispensId) {
      if (!confirm('ยืนยันการลบยาที่จ่ายแล้วใช่หรือไม่?')) return;
      
      try {
        const res = await fetch(`/veterinarian/order_medication/remove_medication/${dispensId}`, {
          method: 'DELETE'
        });
        const json = await res.json();
        
        if (json.success) {
          alert(json.message);
          location.reload();
        } else {
          alert(json.message || 'ลบไม่สำเร็จ');
        }
      } catch (err) {
        alert('เกิดข้อผิดพลาด: ' + err.message);
      }
    }

    // ส่งฟอร์มชำระเงิน
    document.getElementById('payment-form').addEventListener('submit', function(e) {
      const paymentAmount = parseFloat(document.getElementById('payment_amount').value);
      const paymentMethod = document.getElementById('payment_method').value;
      
      if (!paymentAmount || paymentAmount <= 0) {
        e.preventDefault();
        alert('กรุณากรอกจำนวนเงินที่ถูกต้อง');
        return;
      }
      
      if (!paymentMethod) {
        e.preventDefault();
        alert('กรุณาเลือกวิธีการชำระเงิน');
        return;
      }
      
      if (!confirm(`ยืนยันการชำระเงิน ${paymentAmount.toFixed(2)} บาท?`)) {
        e.preventDefault();
        return;
      }
    });
  </script>

</body>
</html>